{{ ansible_managed | comment }}

  upstream backend {
  zone upstreams 64K;
  server 127.0.0.1:8080;
  keepalive 32;
}

  map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

  server {
  listen 80 default_server;
  listen [::]:80 default_server ipv6only=on;
  server_name {{ server_short_hostname }}.{{ domain_tld }};
  return 301 https://$server_name$request_uri;
  server_tokens off;
}

  server {
  server_name {{ server_short_hostname }}.{{ domain_tld }};
  access_log  /var/log/nginx/{{ server_short_hostname }}_access.log;
  error_log   /var/log/nginx/{{ server_short_hostname }}_error.log;
  server_tokens off;
  
  listen 443 ssl;
  listen [::]:443 ssl;
  
  underscores_in_headers on;
  
  ssl_certificate /etc/pki/host_certs/{{ server_short_hostname }}.crt; # managed by Certbot
  ssl_certificate_key /etc/pki/host_certs/{{ server_short_hostname }}.key; # managed by Certbot
  ssl_trusted_certificate /etc/pki/host_certs/ca.crt;
  ssl_dhparam /etc/pki/host_certs/dhparam.pem;
  
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;
  ssl_ciphers "EECDH+AESGCM:EECDH+AES";
  ssl_ecdh_curve secp384r1;
  
  ssl_session_cache shared:SSL:10m;
  ssl_session_tickets off;
  ssl_session_timeout 1d;
  
  ssl_stapling on;
  ssl_stapling_verify on;
  
  add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; reload";
  add_header X-Content-Type-Options nosniff;
  
  
  location / {
  proxy_pass http://backend/guacamole/;
  proxy_redirect off;
  
  proxy_pass_header Authorization;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Ssl on; # Optional
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $connection_upgrade;
  
  client_max_body_size 1g;
  proxy_read_timeout 36000s;
  }

}